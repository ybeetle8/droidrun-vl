# å›¾ç‰‡ä¸æŒ‡ä»¤æäº¤æ–¹å¼å¯¹æ¯”åˆ†æ

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†å¯¹æ¯”äº† **test_screen_analysis.py** æµ‹è¯•è„šæœ¬ä¸ **DroidRun æ¡†æ¶**ä¸­å›¾ç‰‡å’ŒæŒ‡ä»¤æäº¤åˆ° LLM çš„å®ç°æ–¹å¼ï¼Œå¸®åŠ©ç†è§£ä¸¤è€…çš„è®¾è®¡å·®å¼‚å’Œä¼˜åŠ£ã€‚

---

## ä¸€ã€test_screen_analysis.py çš„å®ç°æ–¹å¼

### 1.1 æ ¸å¿ƒæµç¨‹

test_screen_analysis.py æ˜¯ä¸€ä¸ª**ç›´æ¥ã€ç®€å•çš„å•æ¬¡åˆ†æè„šæœ¬**ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

```
è·å–æˆªå›¾å’ŒUIçŠ¶æ€ â†’ æ„å»ºæç¤ºè¯ â†’ åˆ›å»ºæ¶ˆæ¯å— â†’ è°ƒç”¨LLM â†’ æµå¼è¾“å‡ºç»“æœ â†’ ä¿å­˜åˆ°æ–‡ä»¶
```

### 1.2 å›¾ç‰‡æäº¤æ–¹å¼

**æ–‡ä»¶ä½ç½®**ï¼štest/test_screen_analysis.py:46-117

**å®ç°ç»†èŠ‚**ï¼š

```python
# 1. è·å–æˆªå›¾ï¼ˆå­—èŠ‚æ•°æ®ï¼‰
_, screenshot_bytes = adb_tools.take_screenshot(hide_overlay=True)

# 2. æ„å»ºæç¤ºè¯ï¼ˆåŒ…å« UI çŠ¶æ€ JSONï¼‰
prompt = f"""è¯·åˆ†æè¿™ä¸ªAndroidå±å¹•æˆªå›¾å’ŒUIçŠ¶æ€ä¿¡æ¯...
ä¸‹é¢æ˜¯UIçŠ¶æ€çš„JSONæ•°æ®ï¼š
```json
{state_json_str}
```"""

# 3. åˆ›å»ºæ¶ˆæ¯å—ï¼ˆæ–‡æœ¬ + å›¾ç‰‡ï¼‰
content_blocks = [
    TextBlock(text=prompt),
    ImageBlock(image=screenshot_bytes)  # ç›´æ¥ä½¿ç”¨å­—èŠ‚æ•°æ®
]

# 4. æ„å»ºèŠå¤©æ¶ˆæ¯
message = ChatMessage(
    role=MessageRole.USER,
    content=content_blocks,
)

# 5. æµå¼è°ƒç”¨ LLM
response_stream = llm.stream_chat([message], **extra_params)
```

**ç‰¹ç‚¹**ï¼š
- âœ… **ç®€å•ç›´æ¥**ï¼šä¸€æ¬¡æ€§æ„å»ºæ¶ˆæ¯ï¼Œå•è½®å¯¹è¯
- âœ… **æ˜ç¡®çš„æç¤ºè¯**ï¼šè¯¦ç»†çš„åˆ†æè¦æ±‚ï¼ŒåŒ…å« JSON æ ¼å¼çš„ UI çŠ¶æ€
- âœ… **æµå¼è¾“å‡º**ï¼šä½¿ç”¨ `stream_chat` å®æ—¶æ˜¾ç¤ºåˆ†æç»“æœ
- âœ… **å®Œæ•´ä¿å­˜**ï¼šæˆªå›¾ã€UIçŠ¶æ€ã€åˆ†æç»“æœå…¨éƒ¨ä¿å­˜åˆ°æ–‡ä»¶
- âš ï¸ **æ— ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šæ²¡æœ‰å†å²æ¶ˆæ¯ç®¡ç†
- âš ï¸ **å•æ¬¡æ‰§è¡Œ**ï¼šä¸æ”¯æŒå¤šè½®å¯¹è¯æˆ–è¿­ä»£æ‰§è¡Œ

### 1.3 æŒ‡ä»¤æäº¤æ–¹å¼

**æç¤ºè¯ç»“æ„**ï¼š
- æ˜ç¡®çš„åˆ†æä»»åŠ¡ï¼ˆæœç´¢æ¡†ä½ç½®ã€å•†å“ä¿¡æ¯ï¼‰
- è¾“å‡ºæ ¼å¼è¦æ±‚ï¼ˆä¸­æ–‡ã€è¯¦ç»†ã€é¿å…é‡å¤ï¼‰
- UI çŠ¶æ€æ•°æ®ä»¥ JSON æ ¼å¼åµŒå…¥

**å‚æ•°æ§åˆ¶**ï¼š
```python
llm = load_llm(
    provider_name="OpenAILike",
    model=MODEL,
    api_base=API_BASE,
    temperature=0.0,
    request_timeout=60.0,
    max_tokens=4048,  # é™åˆ¶è¾“å‡ºé•¿åº¦
)

# é˜²æ­¢æ— é™å¾ªç¯çš„é¢å¤–å‚æ•°
VLLM_EXTRA_PARAMS = {
    "frequency_penalty": 0.05,  # å‡å°‘é‡å¤
    "presence_penalty": 0.05,   # é¼“åŠ±å¤šæ ·æ€§
}
```

---

## äºŒã€DroidRun æ¡†æ¶çš„å®ç°æ–¹å¼

### 2.1 æ ¸å¿ƒæµç¨‹

DroidRun ä½¿ç”¨**åŸºäº Workflow çš„ ReAct å¾ªç¯**ï¼Œæ˜¯ä¸€ä¸ªå¤æ‚çš„å¤šæ­¥éª¤æ‰§è¡Œæ¡†æ¶ï¼š

```
å‡†å¤‡èŠå¤© â†’ å¤„ç†LLMè¾“å…¥ â†’ LLMæ€è€ƒ â†’ æå–ä»£ç  â†’ æ‰§è¡Œä»£ç  â†’ å¤„ç†ç»“æœ â†’ å¾ªç¯ï¼ˆæœ€å¤šmax_stepsæ¬¡ï¼‰
```

### 2.2 å›¾ç‰‡æäº¤æ–¹å¼

**æ–‡ä»¶ä½ç½®**ï¼šdroidrun/agent/codeact/codeact_agent.py:170-182

**å®ç°ç»†èŠ‚**ï¼š

```python
# 1. åœ¨ handle_llm_input æ­¥éª¤ä¸­åŠ¨æ€æ·»åŠ æˆªå›¾
for context in self.required_context:
    if context == "screenshot":
        # è·å–æˆªå›¾
        screenshot = (self.tools.take_screenshot())[1]

        # å‘é€æˆªå›¾äº‹ä»¶ï¼ˆç”¨äºè½¨è¿¹è®°å½•ï¼‰
        ctx.write_event_to_stream(ScreenshotEvent(screenshot=screenshot))

        # ä¿å­˜åˆ°å·¥ä½œæµä¸Šä¸‹æ–‡
        await ctx.store.set("screenshot", screenshot)

        # å¦‚æœå¯ç”¨è§†è§‰æ¨¡å¼ï¼Œæ·»åŠ å›¾ç‰‡å—åˆ°èŠå¤©å†å²
        if self.vision == True:
            chat_history = await chat_utils.add_screenshot_image_block(
                screenshot, chat_history
            )
```

**æ–‡ä»¶ä½ç½®**ï¼šdroidrun/agent/utils/chat_utils.py:121-128

```python
async def add_screenshot_image_block(screenshot, chat_history, copy=True):
    if screenshot:
        image_block = ImageBlock(image=screenshot)

        if copy:
            # åˆ›å»ºå‰¯æœ¬é¿å…ä¿®æ”¹åŸå§‹å†å²
            chat_history = chat_history.copy()
            chat_history[-1] = message_copy(chat_history[-1])

        # å°†å›¾ç‰‡å—è¿½åŠ åˆ°æœ€åä¸€æ¡æ¶ˆæ¯
        chat_history[-1].blocks.append(image_block)

    return chat_history
```

**ç‰¹ç‚¹**ï¼š
- âœ… **åŠ¨æ€æ³¨å…¥**ï¼šæ ¹æ® `required_context` é…ç½®åŠ¨æ€æ·»åŠ æˆªå›¾
- âœ… **æ¡ä»¶å¯ç”¨**ï¼šé€šè¿‡ `--vision` å‚æ•°æ§åˆ¶æ˜¯å¦ä½¿ç”¨è§†è§‰èƒ½åŠ›
- âœ… **å†å²ä¿ç•™**ï¼šæˆªå›¾æ·»åŠ åˆ°èŠå¤©å†å²ï¼Œæ”¯æŒå¤šè½®å¯¹è¯
- âœ… **ä¸Šä¸‹æ–‡å…±äº«**ï¼šé€šè¿‡ Workflow Context åœ¨æ­¥éª¤é—´å…±äº«æˆªå›¾
- âœ… **è½¨è¿¹è®°å½•**ï¼šé€šè¿‡äº‹ä»¶æµè®°å½•æ‰€æœ‰æˆªå›¾åˆ° EpisodicMemory
- âš ï¸ **å¤æ‚åº¦é«˜**ï¼šéœ€è¦ç†è§£ Workflowã€Contextã€Events ç­‰æ¦‚å¿µ

### 2.3 æŒ‡ä»¤æäº¤æ–¹å¼

**æ–‡ä»¶ä½ç½®**ï¼šdroidrun/agent/codeact/codeact_agent.py:109-142

**æç¤ºè¯æ„å»º**ï¼š

```python
# 1. å‡†å¤‡åˆå§‹ç”¨æˆ·æ¶ˆæ¯
self.user_message = ChatMessage(
    role="user",
    content=PromptTemplate(DEFAULT_CODE_ACT_USER_PROMPT).format(goal=goal),
)

# 2. æ·»åŠ åˆ°èŠå¤©è®°å¿†
await self.chat_memory.aput(self.user_message)
```

**æ–‡ä»¶ä½ç½®**ï¼šdroidrun/agent/codeact/prompts.py:10-13

```python
DEFAULT_CODE_ACT_USER_PROMPT = """**Current Request:**
{goal}

**Is the precondition met? What is your reasoning and the next step to address this request?**
Explain your thought process then provide code in ```python ... ``` tags if needed."""
```

**åŠ¨æ€ä¸Šä¸‹æ–‡æ³¨å…¥**ï¼ˆæ–‡ä»¶ä½ç½®ï¼šcodeact_agent.py:170-201ï¼‰ï¼š

```python
for context in self.required_context:
    if context == "screenshot":
        # æ·»åŠ æˆªå›¾å—ï¼ˆå¦‚å‰æ‰€è¿°ï¼‰

    if context == "ui_state":
        # æ·»åŠ  UI çŠ¶æ€å—
        state = self.tools.get_state()
        chat_history = await chat_utils.add_ui_text_block(
            state["a11y_tree"], chat_history
        )
        chat_history = await chat_utils.add_phone_state_block(
            state["phone_state"], chat_history
        )

    if context == "packages":
        # æ·»åŠ å·²å®‰è£…åº”ç”¨åˆ—è¡¨
        chat_history = await chat_utils.add_packages_block(
            self.tools.list_packages(include_system_apps=True),
            chat_history,
        )
```

**æ–‡ä»¶ä½ç½®**ï¼šdroidrun/agent/utils/chat_utils.py:103-119

```python
async def add_ui_text_block(ui_state, chat_history, copy=True):
    if ui_state:
        # è§£æ JSON å¹¶æ ¼å¼åŒ–ä¸ºè‡ªç„¶è¯­è¨€
        ui_data = json.loads(ui_state) if isinstance(ui_state, str) else ui_state
        formatted_ui = _format_ui_elements(ui_data)

        # åˆ›å»ºæ–‡æœ¬å—ï¼ˆæ ¼å¼åŒ–ä¸ºï¼šindex. className: resourceId, text - boundsï¼‰
        ui_block = TextBlock(
            text=f"\nCurrent Clickable UI elements from the device in the schema "
                 f"'index. className: resourceId, text - bounds(x1,y1,x2,y2)':\n{formatted_ui}\n"
        )

        if copy:
            chat_history = chat_history.copy()
            chat_history[-1] = message_copy(chat_history[-1])

        chat_history[-1].blocks.append(ui_block)

    return chat_history
```

**ç‰¹ç‚¹**ï¼š
- âœ… **ReAct æ¨¡å¼**ï¼šå¼•å¯¼ LLM å…ˆæ€è€ƒï¼Œå†ç”Ÿæˆä»£ç 
- âœ… **ä¸Šä¸‹æ–‡ä¸°å¯Œ**ï¼šåŠ¨æ€æ³¨å…¥æˆªå›¾ã€UIçŠ¶æ€ã€åº”ç”¨åˆ—è¡¨ç­‰
- âœ… **æ ¼å¼åŒ–ä¼˜åŒ–**ï¼šUI çŠ¶æ€ä» JSON è½¬æ¢ä¸ºè‡ªç„¶è¯­è¨€ï¼ˆæ›´æ˜“äº LLM ç†è§£ï¼‰
- âœ… **è®°å¿†ç®¡ç†**ï¼šä½¿ç”¨ `Memory` ç±»ç®¡ç†èŠå¤©å†å²
- âœ… **å†å²é™åˆ¶**ï¼šé€šè¿‡ `_limit_history` é˜²æ­¢ä¸Šä¸‹æ–‡è¿‡é•¿
- âœ… **å·¥å…·æ³¨å…¥**ï¼šç³»ç»Ÿæç¤ºä¸­åŒ…å«æ‰€æœ‰å¯ç”¨å·¥å…·çš„æè¿°

### 2.4 æ¶ˆæ¯å†å²ç®¡ç†

**æ–‡ä»¶ä½ç½®**ï¼šdroidrun/agent/codeact/codeact_agent.py:430-448

```python
def _limit_history(self, chat_history: List[ChatMessage]) -> List[ChatMessage]:
    """é™åˆ¶èŠå¤©å†å²é•¿åº¦ï¼Œé˜²æ­¢ä¸Šä¸‹æ–‡æº¢å‡º"""
    if LLM_HISTORY_LIMIT <= 0:
        return chat_history

    max_messages = LLM_HISTORY_LIMIT * 2
    if len(chat_history) <= max_messages:
        return chat_history

    # ä¿ç•™ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆé€šå¸¸æ˜¯ä»»åŠ¡æè¿°ï¼‰
    preserved_head = []
    if chat_history and chat_history[0].role == "user":
        preserved_head = [chat_history[0]]

    # ä¿ç•™æœ€è¿‘çš„æ¶ˆæ¯
    tail = chat_history[-max_messages:]
    if preserved_head and preserved_head[0] in tail:
        preserved_head = []

    return preserved_head + tail
```

**æ–‡ä»¶ä½ç½®**ï¼šdroidrun/agent/codeact/codeact_agent.py:348-428

```python
async def _get_llm_response(self, ctx: Context, chat_history: List[ChatMessage]):
    # 1. é™åˆ¶å†å²é•¿åº¦
    limited_history = self._limit_history(chat_history)

    # 2. æ·»åŠ ç³»ç»Ÿæç¤º
    messages_to_send = [self.system_prompt] + limited_history

    # 3. æ¶ˆæ¯æ·±æ‹·è´ï¼ˆé¿å…ä¿®æ”¹åŸå§‹æ¶ˆæ¯ï¼‰
    messages_to_send = [chat_utils.message_copy(msg) for msg in messages_to_send]

    # 4. è°ƒç”¨ LLM
    response = await self.llm.achat(messages=messages_to_send)

    # 5. è¿‡æ»¤å›¾ç‰‡å—ï¼ˆç”¨äºä¿å­˜åˆ° EpisodicMemoryï¼‰
    filtered_chat_history = []
    for msg in limited_history:
        filtered_msg = chat_utils.message_copy(msg)
        if hasattr(filtered_msg, "blocks") and filtered_msg.blocks:
            filtered_msg.blocks = [
                block for block in filtered_msg.blocks
                if not isinstance(block, chat_utils.ImageBlock)
            ]
        filtered_chat_history.append(filtered_msg)

    # 6. ä¿å­˜åˆ° Episodic Memory
    step = EpisodicMemoryStep(
        chat_history=json.dumps([{"role": msg.role, "content": msg.content}
                                 for msg in filtered_chat_history]),
        response=json.dumps({"role": response.message.role,
                            "content": response.message.content}),
        timestamp=time.time(),
        screenshot=(await ctx.store.get("screenshot", None))
    )
    self.episodic_memory.steps.append(step)

    return response
```

---

## ä¸‰ã€å…³é”®å·®å¼‚å¯¹æ¯”

| å¯¹æ¯”ç»´åº¦ | test_screen_analysis.py | DroidRun æ¡†æ¶ |
|---------|------------------------|--------------|
| **æ¶æ„æ¨¡å¼** | å•æ¬¡è„šæœ¬æ‰§è¡Œ | Workflow + ReAct å¾ªç¯ |
| **å›¾ç‰‡æäº¤** | ç›´æ¥åˆ›å»º ImageBlock | åŠ¨æ€æ³¨å…¥åˆ°èŠå¤©å†å² |
| **UI çŠ¶æ€æ ¼å¼** | JSON å­—ç¬¦ä¸²åµŒå…¥æç¤ºè¯ | æ ¼å¼åŒ–ä¸ºè‡ªç„¶è¯­è¨€æ–‡æœ¬å— |
| **æç¤ºè¯** | è¯¦ç»†çš„åˆ†æä»»åŠ¡ | ReAct é£æ ¼ï¼ˆæ€è€ƒ â†’ ä»£ç ï¼‰ |
| **ä¸Šä¸‹æ–‡ç®¡ç†** | æ—  | Memory + å†å²é™åˆ¶ |
| **å¤šè½®å¯¹è¯** | ä¸æ”¯æŒ | æ”¯æŒï¼ˆæœ€å¤š max_steps è½®ï¼‰ |
| **ä»£ç æ‰§è¡Œ** | æ—  | æ”¯æŒï¼ˆé€šè¿‡ SimpleCodeExecutorï¼‰ |
| **è½¨è¿¹è®°å½•** | ä¿å­˜åˆ°æ–‡ä»¶ | EpisodicMemory + äº‹ä»¶æµ |
| **é…ç½®çµæ´»æ€§** | ç¡¬ç¼–ç å‚æ•° | Persona + required_context |
| **é”™è¯¯å¤„ç†** | åŸºç¡€å¼‚å¸¸æ•è· | é‡è¯•æœºåˆ¶ + é™æµå¤„ç† |
| **è§†è§‰èƒ½åŠ›æ§åˆ¶** | é»˜è®¤å¯ç”¨ | `--vision` å‚æ•°æ§åˆ¶ |
| **è¾“å‡ºæ–¹å¼** | æµå¼æ‰“å° + æ–‡ä»¶ä¿å­˜ | äº‹ä»¶æµ + Rich æ ¼å¼åŒ– |

---

## å››ã€è¯¦ç»†å·®å¼‚åˆ†æ

### 4.1 æ¶ˆæ¯å—ï¼ˆContent Blocksï¼‰çš„ä½¿ç”¨

**test_screen_analysis.py**ï¼š
```python
# ä¸€æ¬¡æ€§æ„å»ºæ‰€æœ‰å†…å®¹å—
content_blocks = [
    TextBlock(text=prompt),      # æç¤ºè¯ï¼ˆåŒ…å« UI JSONï¼‰
    ImageBlock(image=screenshot) # æˆªå›¾
]
message = ChatMessage(role=MessageRole.USER, content=content_blocks)
```

**DroidRun**ï¼š
```python
# é€æ­¥è¿½åŠ å†…å®¹å—åˆ°æœ€åä¸€æ¡æ¶ˆæ¯
chat_history[-1].blocks.append(TextBlock(text=ui_text))        # UI çŠ¶æ€
chat_history[-1].blocks.append(TextBlock(text=phone_state))    # æ‰‹æœºçŠ¶æ€
chat_history[-1].blocks.append(ImageBlock(image=screenshot))   # æˆªå›¾
```

**å·®å¼‚**ï¼š
- test_screen_analysis.pyï¼š**ä¸€æ¬¡æ€§æ„å»º**ï¼Œé€‚åˆå•è½®å¯¹è¯
- DroidRunï¼š**åŠ¨æ€è¿½åŠ **ï¼Œæ”¯æŒå¤šè½®å¯¹è¯å’Œä¸Šä¸‹æ–‡ç´¯ç§¯

### 4.2 UI çŠ¶æ€çš„è¡¨ç¤ºæ–¹å¼

**test_screen_analysis.py**ï¼š
```python
# ç›´æ¥åµŒå…¥ JSON å­—ç¬¦ä¸²
prompt = f"""...
ä¸‹é¢æ˜¯UIçŠ¶æ€çš„JSONæ•°æ®ï¼š
```json
{state_json_str}
```"""
```

**DroidRun**ï¼š
```python
# æ ¼å¼åŒ–ä¸ºè‡ªç„¶è¯­è¨€ï¼ˆchat_utils.py:50-101ï¼‰
def _format_ui_elements(ui_data, level=0) -> str:
    """
    æ ¼å¼ï¼šindex. className: resourceId, text - bounds
    ç¤ºä¾‹ï¼š
    0. TextView: "com.example:id/title", "Hello" - (100,200,500,300)
      1. Button: "com.example:id/btn", "Click" - (150,250,450,280)
    """
    # ... é€’å½’æ ¼å¼åŒ–ï¼Œæ”¯æŒç¼©è¿›è¡¨ç¤ºå±‚çº§
```

**å·®å¼‚**ï¼š
- test_screen_analysis.pyï¼š**JSON æ ¼å¼**ï¼Œç»“æ„æ¸…æ™°ä½†å†—é•¿
- DroidRunï¼š**è‡ªç„¶è¯­è¨€æ ¼å¼**ï¼Œæ›´ç®€æ´ï¼Œæ›´æ˜“äº LLM ç†è§£

### 4.3 å›¾ç‰‡æ•°æ®çš„æ¥æº

**test_screen_analysis.py**ï¼š
```python
# æ¯æ¬¡ä»è®¾å¤‡è·å–
_, screenshot_bytes = adb_tools.take_screenshot(hide_overlay=True)
```

**DroidRun**ï¼š
```python
# 1. è·å–å¹¶ä¿å­˜åˆ° Context
screenshot = (self.tools.take_screenshot())[1]
await ctx.store.set("screenshot", screenshot)

# 2. åç»­æ­¥éª¤å¯å¤ç”¨
screenshot = await ctx.store.get("screenshot", None)
```

**å·®å¼‚**ï¼š
- test_screen_analysis.pyï¼š**ä¸€æ¬¡æ€§ä½¿ç”¨**
- DroidRunï¼š**Context å…±äº«**ï¼Œå¯åœ¨å¤šä¸ªæ­¥éª¤ä¸­å¤ç”¨ï¼ˆå¦‚ä¿å­˜åˆ° EpisodicMemoryï¼‰

### 4.4 LLM è°ƒç”¨æ–¹å¼

**test_screen_analysis.py**ï¼š
```python
# æµå¼è°ƒç”¨ï¼Œå®æ—¶è¾“å‡º
response_stream = llm.stream_chat([message], **extra_params)
for chunk in response_stream:
    print(chunk.delta, end="", flush=True)
```

**DroidRun**ï¼š
```python
# å¼‚æ­¥è°ƒç”¨ï¼Œç­‰å¾…å®Œæ•´å“åº”
response = await self.llm.achat(messages=messages_to_send)

# æå–ä»£ç å’Œæ€è€ƒ
code, thoughts = chat_utils.extract_code_and_thought(response.message.content)

# å¦‚æœæœ‰ä»£ç ï¼Œæ‰§è¡Œå®ƒ
if code:
    result = await self.executor.execute(ctx, code)
```

**å·®å¼‚**ï¼š
- test_screen_analysis.pyï¼š**æµå¼è¾“å‡º**ï¼Œç”¨æˆ·å‹å¥½
- DroidRunï¼š**å®Œæ•´å“åº” + ä»£ç æ‰§è¡Œ**ï¼Œæ”¯æŒ ReAct å¾ªç¯

### 4.5 ç³»ç»Ÿæç¤ºçš„æ„å»º

**test_screen_analysis.py**ï¼š
```python
# æ— ç³»ç»Ÿæç¤ºï¼Œæ‰€æœ‰æŒ‡ä»¤åœ¨ç”¨æˆ·æ¶ˆæ¯ä¸­
```

**DroidRun**ï¼š
```python
# ç³»ç»Ÿæç¤ºåŒ…å«å·¥å…·æè¿°ï¼ˆcodeact_agent.py:89-94ï¼‰
self.system_prompt_content = persona.system_prompt.format(
    tool_descriptions=self.tool_descriptions  # æ‰€æœ‰å¯ç”¨å·¥å…·çš„å‡½æ•°ç­¾å
)
self.system_prompt = ChatMessage(role="system", content=self.system_prompt_content)

# å‘é€æ—¶ï¼š[system_prompt] + [èŠå¤©å†å²]
messages_to_send = [self.system_prompt] + limited_history
```

**å·®å¼‚**ï¼š
- test_screen_analysis.pyï¼š**æ— ç³»ç»Ÿæç¤º**ï¼Œé€‚åˆç®€å•åˆ†æä»»åŠ¡
- DroidRunï¼š**è¯¦ç»†çš„ç³»ç»Ÿæç¤º**ï¼ŒåŒ…å«æ‰€æœ‰å·¥å…·æè¿°å’Œ ReAct æŒ‡å¯¼

---

## äº”ã€é€‚ç”¨åœºæ™¯å¯¹æ¯”

### test_screen_analysis.py é€‚åˆï¼š
- âœ… **å¿«é€ŸåŸå‹éªŒè¯**ï¼šæµ‹è¯• LLM çš„è§†è§‰åˆ†æèƒ½åŠ›
- âœ… **å•æ¬¡åˆ†æä»»åŠ¡**ï¼šç”ŸæˆæŠ¥å‘Šã€æå–ä¿¡æ¯
- âœ… **è°ƒè¯•å’Œå®éªŒ**ï¼šè°ƒæ•´æç¤ºè¯ã€å‚æ•°
- âœ… **æ•°æ®æ”¶é›†**ï¼šæ‰¹é‡åˆ†ææˆªå›¾å¹¶ä¿å­˜ç»“æœ

### DroidRun æ¡†æ¶é€‚åˆï¼š
- âœ… **å¤æ‚ä»»åŠ¡æ‰§è¡Œ**ï¼šéœ€è¦å¤šæ­¥éª¤æ“ä½œï¼ˆæ‰“å¼€åº”ç”¨ã€ç‚¹å‡»ã€è¾“å…¥ï¼‰
- âœ… **æ™ºèƒ½ä»£ç†**ï¼šè‡ªä¸»å†³ç­–å’Œä»£ç ç”Ÿæˆ
- âœ… **é•¿æœŸè¿è¡Œ**ï¼šå¤šè½®äº¤äº’ã€é”™è¯¯æ¢å¤
- âœ… **å¯æ‰©å±•æ€§**ï¼šé€šè¿‡ Persona å’Œ Tools å®šåˆ¶è¡Œä¸º

---

## å…­ã€å…³é”®æŠ€æœ¯ç‚¹æ€»ç»“

### 6.1 å›¾ç‰‡æäº¤çš„æ ¸å¿ƒåŸç†

ä¸¤è€…éƒ½ä½¿ç”¨ `llama_index` çš„ `ImageBlock`ï¼š

```python
from llama_index.core.base.llms.types import ImageBlock

# åˆ›å»ºå›¾ç‰‡å—ï¼ˆæ¥å—å­—èŠ‚æ•°æ®ï¼‰
image_block = ImageBlock(image=screenshot_bytes)
```

**å·®å¼‚åœ¨äº**ï¼š
1. **ä½•æ—¶åˆ›å»º**ï¼š
   - test_screen_analysis.pyï¼šè°ƒç”¨ LLM å‰
   - DroidRunï¼šæ¯ä¸ª ReAct æ­¥éª¤åŠ¨æ€åˆ›å»º

2. **å¦‚ä½•ä¼ é€’**ï¼š
   - test_screen_analysis.pyï¼šç›´æ¥æ”¾å…¥æ¶ˆæ¯çš„ `content` åˆ—è¡¨
   - DroidRunï¼šè¿½åŠ åˆ° `chat_history[-1].blocks`

3. **æ˜¯å¦ä¿ç•™**ï¼š
   - test_screen_analysis.pyï¼šä¸ä¿ç•™å†å²
   - DroidRunï¼šä¿ç•™åœ¨ `Memory` ä¸­ï¼ˆä½†å‘é€åˆ° EpisodicMemory æ—¶ä¼šè¿‡æ»¤ï¼‰

### 6.2 UI çŠ¶æ€çš„å¤„ç†å·®å¼‚

| æ–¹é¢ | test_screen_analysis.py | DroidRun |
|-----|------------------------|----------|
| **æ•°æ®æ¥æº** | `adb_tools.get_state()` | `self.tools.get_state()["a11y_tree"]` |
| **æ ¼å¼** | JSON å­—ç¬¦ä¸² | è‡ªç„¶è¯­è¨€ï¼ˆæ ¼å¼åŒ–ï¼‰ |
| **åµŒå…¥æ–¹å¼** | f-string åµŒå…¥æç¤ºè¯ | TextBlock è¿½åŠ åˆ°æ¶ˆæ¯å— |
| **ç¤ºä¾‹** | `{"index": 0, "text": "Hello"}` | `0. TextView: "Hello" - (100,200,500,300)` |

### 6.3 æç¤ºè¯è®¾è®¡å·®å¼‚

**test_screen_analysis.py**ï¼ˆåˆ†æå¯¼å‘ï¼‰ï¼š
```
è¯·åˆ†æè¿™ä¸ªAndroidå±å¹•æˆªå›¾å’ŒUIçŠ¶æ€ä¿¡æ¯ï¼Œæä¾›è¯¦ç»†çš„åˆ†ææŠ¥å‘Šã€‚

1. **å±å¹•æ¦‚è§ˆ**
   - æœç´¢æ¡†çš„ä½ç½® index å’Œ x,y åæ ‡

2. **å†…å®¹åˆ†æ**
   - å•†å“è¯¦ç»†ä¿¡æ¯ï¼Œè¦åˆ—å‡ºæ¥...
```

**DroidRun**ï¼ˆè¡ŒåŠ¨å¯¼å‘ï¼‰ï¼š
```
**Current Request:**
æ‰“å¼€æ·˜å®å¹¶æœç´¢ iPhone

**Is the precondition met? What is your reasoning and the next step?**
Explain your thought process then provide code in ```python ... ``` tags.
```

**å·®å¼‚**ï¼š
- test_screen_analysis.pyï¼š**æè¿°å‹ä»»åŠ¡**ï¼ˆåˆ†æã€æ€»ç»“ï¼‰
- DroidRunï¼š**æ‰§è¡Œå‹ä»»åŠ¡**ï¼ˆä»£ç ç”Ÿæˆã€æ“ä½œè®¾å¤‡ï¼‰

---

## ä¸ƒã€å®ç°å»ºè®®

### 7.1 å¦‚æœä½ æƒ³åœ¨ test_screen_analysis.py ä¸­ä½¿ç”¨ DroidRun çš„æŠ€æœ¯

1. **æ·»åŠ èŠå¤©å†å²ç®¡ç†**ï¼š
```python
from llama_index.core.memory import Memory

chat_memory = Memory.from_defaults()
await chat_memory.aput(user_message)

# å¤šè½®å¯¹è¯
for i in range(3):
    response = await llm.achat(chat_memory.get_all())
    await chat_memory.aput(response.message)
```

2. **åŠ¨æ€è¿½åŠ å†…å®¹å—**ï¼š
```python
# åˆå§‹æ¶ˆæ¯
message = ChatMessage(role="user", content="åˆ†æè¿™ä¸ªå±å¹•")

# è¿½åŠ  UI çŠ¶æ€
message.blocks.append(TextBlock(text=f"UI: {ui_state}"))

# è¿½åŠ æˆªå›¾
message.blocks.append(ImageBlock(image=screenshot))
```

3. **æ ¼å¼åŒ– UI çŠ¶æ€**ï¼š
```python
# å¤ç”¨ DroidRun çš„æ ¼å¼åŒ–å‡½æ•°
from droidrun.agent.utils.chat_utils import _format_ui_elements

formatted_ui = _format_ui_elements(state_data)
ui_block = TextBlock(text=f"UIå…ƒç´ :\n{formatted_ui}")
```

### 7.2 å¦‚æœä½ æƒ³åœ¨ DroidRun ä¸­ä½¿ç”¨ test_screen_analysis.py çš„æŠ€æœ¯

1. **æµå¼è¾“å‡º**ï¼š
```python
# åœ¨ _get_llm_response ä¸­
response_stream = self.llm.stream_chat(messages=messages_to_send)
for chunk in response_stream:
    print(chunk.delta, end="", flush=True)
```

2. **ä¿å­˜è¯¦ç»†åˆ†æç»“æœ**ï¼š
```python
# åœ¨ finalize æ­¥éª¤ä¸­
analysis_file = Path(f"analysis_{timestamp}.md")
with open(analysis_file, "w", encoding="utf-8") as f:
    f.write(self.chat_memory.get_all())
```

3. **æ·»åŠ é˜²é‡å¤å‚æ•°**ï¼š
```python
# åœ¨ load_llm ä¸­
llm = load_llm(
    ...,
    frequency_penalty=0.05,
    presence_penalty=0.05,
)
```

---

## å…«ã€æ€»ç»“

### test_screen_analysis.py çš„ä¼˜åŠ¿
- ğŸ¯ **ç®€å•ç›´æ¥**ï¼šé€‚åˆå¿«é€ŸéªŒè¯å’Œå®éªŒ
- ğŸ“Š **å®Œæ•´è®°å½•**ï¼šä¿å­˜æˆªå›¾ã€çŠ¶æ€ã€åˆ†æç»“æœ
- ğŸš€ **å¿«é€Ÿè¿­ä»£**ï¼šè°ƒæ•´æç¤ºè¯å’Œå‚æ•°å¾ˆæ–¹ä¾¿
- ğŸ’¡ **æ˜“äºç†è§£**ï¼šä»£ç é€»è¾‘æ¸…æ™°ï¼Œé€‚åˆå­¦ä¹ 

### DroidRun çš„ä¼˜åŠ¿
- ğŸ—ï¸ **æ¶æ„å®Œå–„**ï¼šWorkflow + ReAct + Memory + Events
- ğŸ”„ **å¤šè½®äº¤äº’**ï¼šæ”¯æŒå¤æ‚ä»»åŠ¡çš„è¿­ä»£æ‰§è¡Œ
- ğŸ› ï¸ **å·¥å…·ä¸°å¯Œ**ï¼šåŠ¨æ€å·¥å…·æ³¨å…¥ + ä»£ç æ‰§è¡Œ
- ğŸ“ˆ **å¯æ‰©å±•æ€§**ï¼šPersona ç³»ç»Ÿæ”¯æŒä¸“ä¸šåŒ–ä»£ç†
- ğŸ” **è½¨è¿¹è¿½è¸ª**ï¼šEpisodicMemory è®°å½•å®Œæ•´æ‰§è¡Œå†å²

### å…³é”®å¯ç¤º

1. **å›¾ç‰‡æäº¤æœ¬è´¨ç›¸åŒ**ï¼šéƒ½ä½¿ç”¨ `ImageBlock(image=bytes)`
2. **å·®å¼‚åœ¨äºæ¶æ„**ï¼šå•æ¬¡ vs å¤šè½®ï¼Œé™æ€ vs åŠ¨æ€
3. **UI çŠ¶æ€æ ¼å¼åŒ–**ï¼šè‡ªç„¶è¯­è¨€æ ¼å¼æ›´å‹å¥½
4. **ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šMemory æ˜¯å¤šè½®å¯¹è¯çš„å…³é”®
5. **æç¤ºè¯è®¾è®¡**ï¼šæ ¹æ®ä»»åŠ¡ç±»å‹ï¼ˆåˆ†æ vs æ‰§è¡Œï¼‰è°ƒæ•´

---

## ä¹ã€ä»£ç ä½ç½®ç´¢å¼•

| åŠŸèƒ½ | test_screen_analysis.py | DroidRun |
|-----|------------------------|----------|
| **å›¾ç‰‡æäº¤** | 90-94 è¡Œ | codeact_agent.py:173-182<br>chat_utils.py:121-128 |
| **UI çŠ¶æ€å¤„ç†** | 66-88 è¡Œ | chat_utils.py:50-119 |
| **æç¤ºè¯æ„å»º** | 68-88 è¡Œ | codeact_agent.py:126-135<br>prompts.py:10-13 |
| **LLM è°ƒç”¨** | 102-117 è¡Œ | codeact_agent.py:348-428 |
| **å†å²ç®¡ç†** | æ—  | codeact_agent.py:430-448 |
| **ç»“æœä¿å­˜** | 120-160 è¡Œ | context/episodic_memory.py |

---

## é™„å½•ï¼šå®Œæ•´æµç¨‹å›¾

### test_screen_analysis.py æµç¨‹
```
main()
  â”œâ”€ AdbTools(use_tcp=True)
  â”œâ”€ get_screenshot_and_state()
  â”‚   â”œâ”€ take_screenshot() â†’ screenshot_bytes
  â”‚   â””â”€ get_state() â†’ state_data
  â”œâ”€ load_llm()
  â”œâ”€ analyze_screen_with_llm()
  â”‚   â”œâ”€ æ„å»º prompt (åŒ…å« JSON)
  â”‚   â”œâ”€ åˆ›å»º content_blocks [TextBlock, ImageBlock]
  â”‚   â”œâ”€ stream_chat([message], **extra_params)
  â”‚   â””â”€ æµå¼è¾“å‡ºç»“æœ
  â””â”€ save_analysis_result()
      â”œâ”€ ä¿å­˜ screenshot_*.png
      â”œâ”€ ä¿å­˜ state_*.json
      â””â”€ ä¿å­˜ analysis_*.md
```

### DroidRun CodeActAgent æµç¨‹
```
run() [Workflow]
  â”œâ”€ prepare_chat()
  â”‚   â”œâ”€ åˆ›å»º user_message (goal)
  â”‚   â””â”€ chat_memory.aput(user_message)
  â”œâ”€ handle_llm_input() [å¾ªç¯ max_steps æ¬¡]
  â”‚   â”œâ”€ åŠ¨æ€æ³¨å…¥ä¸Šä¸‹æ–‡
  â”‚   â”‚   â”œâ”€ add_screenshot_image_block()
  â”‚   â”‚   â”œâ”€ add_ui_text_block() [æ ¼å¼åŒ–]
  â”‚   â”‚   â””â”€ add_phone_state_block()
  â”‚   â”œâ”€ _get_llm_response()
  â”‚   â”‚   â”œâ”€ _limit_history()
  â”‚   â”‚   â”œâ”€ llm.achat([system_prompt] + history)
  â”‚   â”‚   â””â”€ ä¿å­˜åˆ° EpisodicMemory
  â”‚   â””â”€ extract_code_and_thought()
  â”œâ”€ execute_code()
  â”‚   â”œâ”€ SimpleCodeExecutor.execute(code)
  â”‚   â””â”€ è®°å½• screenshots/ui_states
  â”œâ”€ handle_execution_result()
  â”‚   â””â”€ chat_memory.aput(observation)
  â””â”€ finalize()
      â”œâ”€ _add_final_state_observation()
      â””â”€ è¿”å› StopEvent(result)
```

---

**åˆ›å»ºæ—¶é—´**ï¼š2025-10-29
**ä½œè€…**ï¼šClaude Code
**å‚è€ƒæ–‡ä»¶**ï¼š
- test/test_screen_analysis.py
- droidrun/agent/codeact/codeact_agent.py
- droidrun/agent/utils/chat_utils.py
- notes/DroidRuné¡¹ç›®ä»£ç ç»“æ„è¯¦è§£.md
