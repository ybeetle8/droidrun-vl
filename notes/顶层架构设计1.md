# 智能手机操作 Agent 顶层架构设计

> **设计理念**: 在技术易实现的范围内模拟人类行为,构建可持续、自主学习的移动应用操作系统

## 一、核心设计思想

### 1.1 技术实用主义
- 模拟人类行为,但不过度追求完全仿真
- 在效果与复杂度之间寻找最佳平衡点
- 优先实现核心功能,逐步增强高级特性

### 1.2 自主任务管理
- 系统能够持续运行,不依赖外部干预
- 自动检测任务偏离并纠正
- 支持无限期循环任务和有终点任务

### 1.3 经验积累学习
- 从成功和失败中持续学习
- 构建关于应用操作的知识库
- 提升执行效率和成功率

---

## 二、整体架构

### 2.1 系统分层视图

```
┌──────────────────────────────────────────────────────────────┐
│                    用户任务输入层                               │
│             ("到闲鱼购买200元以内的1TB硬盘")                      │
└───────────────────────┬──────────────────────────────────────┘
                        │
┌───────────────────────▼──────────────────────────────────────┐
│                  Master 核心任务管理器                          │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  职责:                                                  │  │
│  │  1. 任务生命周期管理 (启动/暂停/恢复/终止)               │  │
│  │  2. 任务执行监督 (防止偏离目标)                         │  │
│  │  3. 异常情况接管 (App退出/卡死/环境变化)                 │  │
│  │  4. 任务完成判定 (明确终点 vs 持续循环)                  │  │
│  │  5. 子任务分解与调度                                     │  │
│  └────────────────────────────────────────────────────────┘  │
└───────────────────────┬──────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
┌───────▼─────┐  ┌──────▼──────┐  ┌───▼────────┐
│ 长期记忆系统 │  │  执行代理层  │  │ 环境感知层 │
│             │  │             │  │            │
│ - 操作经验库│  │ - 子任务执行│  │ - 屏幕分析 │
│ - 成功模式  │◄─┤ - 动态决策  ├─►│ - 控件识别 │
│ - 失败教训  │  │ - 试错纠正  │  │ - 状态监测 │
│ - UI知识图谱│  │ - 持续观察  │  │            │
└─────────────┘  └─────────────┘  └────────────┘
        │               │               │
        └───────────────┴───────────────┘
                        │
┌───────────────────────▼──────────────────────────────────────┐
│                    设备操作层 (ADB/UIAutomator)                │
│                  (点击/滑动/输入/截图/App管理)                   │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件关系

```
任务输入
    ↓
Master 分析任务特征
    ├─ 类型: 有终点任务 / 无终点循环任务
    ├─ 复杂度: 单步 / 多步 / 超复杂
    └─ 熟悉度: 有经验 / 部分经验 / 全新任务
    ↓
检索长期记忆
    ├─ 命中经验 → 快速路径 (直接复用操作序列)
    └─ 无经验 → 探索路径 (调用执行代理探索)
    ↓
分解子任务并执行
    ↓
Master 持续监督
    ├─ 每个子任务完成后检查进度
    ├─ 检测异常 (App退出/页面错误/操作卡死)
    └─ 触发纠正 (重新打开App/恢复页面/重新规划)
    ↓
判断任务状态
    ├─ 有终点任务: 达成目标 → 记录成功经验 → 结束
    └─ 无终点任务: 完成一轮 → 记录经验 → 继续下一轮
```

---

## 三、Master 核心任务管理器详细设计

### 3.1 核心职能

#### 职能 1: 任务理解与规划
- **输入分析**: 解析用户意图,识别任务类型和终止条件
- **目标拆解**: 将复杂任务分解为可管理的子任务序列
- **执行策略**: 基于经验决定是复用还是探索

#### 职能 2: 执行监督与纠偏
- **进度追踪**: 实时监控子任务执行状态
- **偏离检测**: 识别何时偏离预期路径
- **主动介入**: 检测到偏离时接管控制

#### 职能 3: 异常处理与恢复
- **异常类型识别**:
  - App 意外退出 → 重新启动 App
  - 页面错误/卡死 → 强制返回或重启
  - 网络/权限问题 → 触发环境修复
- **状态恢复**: 将任务恢复到正确的执行点

#### 职能 4: 任务完成判定
- **有终点任务**: 验证目标达成条件 (如"已加入购物车")
- **无终点任务**: 判断单轮完成,自动触发下一轮

#### 职能 5: 经验管理
- **成功经验沉淀**: 任务完成后提取关键路径
- **失败教训记录**: 分析失败原因,标记失效操作
- **知识库更新**: 持续优化长期记忆

### 3.2 典型场景处理

#### 场景 A: "到闲鱼 App,购买 200 元以内的 1TB 硬盘"

```
Master 解析:
  任务类型: 有终点任务
  终止条件: 下单成功 或 加入购物车
  子任务: [打开闲鱼] → [搜索"1TB硬盘"] → [筛选价格] → [选择商品] → [加入购物车]

执行流程:
  1. 启动闲鱼 App
  2. 执行子任务 1: 打开闲鱼
     └─ 成功 → 继续
     └─ 失败 (如意外返回桌面) → Master 接管,重新打开

  3. 执行子任务 2: 搜索"1TB硬盘"
     └─ 期望: 进入搜索结果页
     └─ 实际: 误点击了其他按钮,进入推荐页
     └─ Master 检测偏离 → 返回首页 → 重新执行子任务 2

  4. 执行子任务 3-5...

  5. Master 验证完成条件
     └─ 检测到"已加入购物车"提示 → 任务完成
     └─ 提取成功路径 → 保存到长期记忆
     └─ 终止任务
```

#### 场景 B: "访问 Twitter,随机浏览贴文并善意回复,一直循环永不停止"

```
Master 解析:
  任务类型: 无终点循环任务
  终止条件: 无 (除非用户手动停止)
  单轮子任务: [打开Twitter] → [浏览Feed] → [选择一条贴文] → [生成回复] → [发送]

执行流程:
  Loop:
    1. 执行单轮子任务
    2. Master 检测单轮完成
       └─ 检测到"回复已发送" → 单轮成功
       └─ 记录本轮操作经验
    3. Master 决策: 继续下一轮
       └─ 等待 2-5 秒 (模拟人类间隔)
       └─ 启动下一轮

    异常处理:
      - 如果 Twitter 崩溃 → Master 重启 App → 继续
      - 如果出现"发送失败" → 标记失败经验 → 跳过该贴文 → 继续
```

---

## 四、执行代理层设计

### 4.1 子任务执行模式

```
执行代理 (Sub-Agent)
    ↓
观察当前屏幕
    ├─ 视觉理解 (识别页面类型和元素)
    ├─ 检索长期记忆 (是否有相似场景经验)
    └─ 综合分析当前状态
    ↓
决策下一步操作
    ├─ 有把握 (置信度 > 0.9) → 直接执行
    ├─ 不确定 (置信度 0.5-0.9) → 多方案评估后执行
    └─ 完全陌生 → 试探性操作
    ↓
执行操作
    ↓
即时反馈验证 (0.5秒内)
    ├─ 成功 (页面符合预期) → 继续
    ├─ 失败 (明显错误) → 回退
    └─ 不确定 → 继续观察
    ↓
更新工作记忆
    ├─ 记录刚才的操作
    ├─ 检测循环 (避免 A-B-A-B 死循环)
    └─ 上报进度给 Master
```

### 4.2 与 Master 的交互

- **定期心跳**: 执行代理每完成一个操作后向 Master 报告
- **异常上报**: 遇到无法处理的情况时请求 Master 介入
- **完成通知**: 子任务完成后等待 Master 指令 (继续/终止/切换任务)

---

## 五、长期记忆系统设计

### 5.1 记忆内容结构

#### 操作经验库
```
任务描述: "在淘宝搜索某商品"
关键操作序列:
  1. 点击搜索框 (通常在顶部)
  2. 输入关键词
  3. 点击搜索按钮 (放大镜图标)
预期结果: 进入搜索结果页
成功次数: 15
失败次数: 1
最后使用时间: 2025-11-01
```

#### UI 知识图谱
```
应用: Twitter
页面: 贴文详情页
元素知识:
  - 回复按钮: 通常在贴文底部左侧,对话气泡图标
  - 输入框: 点击回复按钮后出现在屏幕底部
  - 发送按钮: 输入框右侧,输入内容后变为蓝色可点击
操作顺序: 点击回复 → 等待输入框出现 → 输入文字 → 点击发送
注意事项: 有时需要等待 1-2 秒输入框才完全加载
```

#### 失败模式库
```
场景: 淘宝商品详情页
错误操作: 点击商品图片
预期: 查看大图
实际: 进入了直播间
教训: 图片下方如果有"直播中"标签,不要点击图片
```

### 5.2 记忆检索与应用

#### 快速路径 (经验复用)
```
用户任务: "打开微信并发送消息给张三"
    ↓
Master 检索记忆
    ↓
命中相似任务 (相似度 > 0.85)
    ↓
直接执行已知操作序列
    [打开微信] → [点击搜索] → [输入"张三"] → [选择联系人] → [点击发送框] → [输入消息] → [发送]
    ↓
执行耗时: 5-10 秒 (vs 首次探索需要 30-60 秒)
```

#### 探索路径 (无经验)
```
用户任务: "在新安装的某 App 中完成注册"
    ↓
Master 检索记忆
    ↓
无匹配经验 (新 App)
    ↓
启动探索模式
    ├─ 执行代理观察屏幕
    ├─ 基于通用 UI 知识推测操作 (如"注册按钮通常在底部")
    ├─ 试错式探索
    └─ 记录每一步操作结果
    ↓
任务完成后
    ↓
提取成功路径 → 保存到长期记忆
```

### 5.3 持续学习机制

- **成功强化**: 每次成功复用经验,该经验的可信度 +1
- **失败修正**: 经验失效时标记,并尝试新的操作路径
- **自动泛化**: 识别多个相似任务的共同模式,提取通用操作模板
- **垃圾清理**: 定期清理 90 天未使用且成功率低的过时经验

---

## 六、关键技术特性

### 6.1 任务不偏离保障

**Master 监督机制**:
1. **目标锚定**: 每个子任务都有明确的预期结果
2. **实时比对**: 子任务完成后验证当前状态是否符合预期
3. **偏离检测**:
   - 连续 3 步操作未向目标推进 → 判定为偏离
   - 当前页面与预期完全不符 → 判定为偏离
4. **纠正策略**:
   - 轻度偏离 (如误点旁边按钮) → 返回上一步
   - 中度偏离 (如进入错误页面) → 返回首页重新开始
   - 重度偏离 (如 App 退出) → 重启 App,恢复到最后正确状态

### 6.2 无限循环任务支持

**循环管理机制**:
1. **单轮定义**: 明确什么算"完成一轮"
   - 例: "浏览并回复一条贴文" = 一轮
2. **轮次计数**: 记录已完成轮次
3. **异常退出保护**: 每轮完成后保存检查点,崩溃后可恢复
4. **疲劳管理**: 长时间运行后降低操作频率,模拟人类疲劳

### 6.3 经验积累与加速

**学习曲线**:
```
首次执行某任务: 30-60 秒 (探索 + 试错)
第 2 次执行: 10-20 秒 (部分复用经验)
第 5 次执行: 5-10 秒 (完全熟练)
第 10 次执行: 3-5 秒 (接近人类熟练操作速度)
```

**知识泛化**:
- 在多个电商 App (淘宝/京东/拼多多) 执行搜索任务后
- 系统自动提取"电商 App 搜索"的通用模式
- 下次遇到新电商 App 时,直接应用该模式,大幅减少探索时间

---

## 七、系统工作流程示例

### 7.1 完整执行流程

```
[用户输入]
  "到闲鱼购买 200 元以内的 1TB 硬盘"

[Master 任务理解]
  任务类型: 购物类,有终点
  主要步骤: 打开 App → 搜索 → 筛选 → 选择 → 下单
  终止条件: 加入购物车 或 下单成功

[Master 检索长期记忆]
  发现相似任务: "在闲鱼购买二手相机" (相似度 0.78)
  决策: 部分复用经验,动态调整

[Master 分解子任务]
  子任务 1: 启动闲鱼 App
  子任务 2: 进入搜索
  子任务 3: 搜索"1TB 硬盘"
  子任务 4: 设置价格筛选 "< 200元"
  子任务 5: 浏览商品列表
  子任务 6: 选择合适商品
  子任务 7: 加入购物车

[执行子任务 1: 启动闲鱼]
  执行代理: 检索记忆,找到"启动闲鱼"经验
  操作: 点击闲鱼图标 (桌面第 2 屏)
  验证: 等待 2 秒,检测到闲鱼首页 → 成功
  上报 Master: 子任务 1 完成

[执行子任务 2-3: 搜索]
  执行代理: 观察屏幕,识别搜索框 (顶部)
  操作: 点击搜索框 → 输入"1TB 硬盘" → 点击搜索按钮
  验证: 检测到搜索结果页 → 成功
  上报 Master: 子任务 2-3 完成

[执行子任务 4: 价格筛选]
  执行代理: 在搜索结果页寻找"筛选"按钮
  操作: 点击筛选 → 选择价格 → 输入"0-200" → 确认
  意外情况: 误点击了"综合排序",进入排序选项
  执行代理: 检测到偏离,按返回键
  重试: 重新寻找"筛选"按钮 → 成功
  上报 Master: 子任务 4 完成 (含 1 次纠错)

[执行子任务 5-7: 选择商品]
  执行代理: 浏览商品列表
  决策逻辑:
    - 检查价格是否符合 (< 200元)
    - 检查描述是否包含"1TB"
    - 检查卖家信用
  操作: 点击第 3 个商品 → 查看详情 → 点击"加入购物车"
  验证: 检测到"已加入购物车"提示 → 成功
  上报 Master: 子任务 5-7 完成

[Master 判定任务完成]
  验证终止条件: ✓ 商品已加入购物车
  提取成功路径 → 保存到长期记忆
  经验标记: "在闲鱼购买硬盘" (成功)
  任务耗时: 总计 35 秒

[系统输出]
  "任务完成: 已将 1TB 硬盘 (价格 185 元) 加入购物车"
```

---

## 八、实施优先级

### Phase 1: 核心框架 (2-3 周)
- Master 核心任务管理器基础功能
- 子任务分解与调度
- 基础执行代理 (观察 → 决策 → 执行 → 验证)
- 简单的任务完成判定

### Phase 2: 监督与纠偏 (2-3 周)
- 偏离检测机制
- 异常处理与恢复
- Master 接管与状态恢复
- 循环任务支持

### Phase 3: 长期记忆集成 (3-4 周)
- 操作经验库
- 经验检索与复用
- 成功/失败模式学习
- UI 知识图谱

### Phase 4: 优化与增强 (持续)
- 经验泛化
- 执行速度优化
- 更智能的异常处理
- 多任务并发管理

---

## 九、预期效果

### 首次执行 (无经验)
- 复杂任务耗时: 30-90 秒
- 需要试错和探索
- 可能出现 1-3 次纠错

### 多次执行 (有经验)
- 相同任务耗时: 5-15 秒 (3-6x 加速)
- 几乎无需试错
- 接近人类熟练操作速度

### 长期运行
- 知识库持续积累
- 处理新任务速度越来越快
- 对 UI 变化的适应能力增强

---

## 十、设计亮点

1. **Master 监督机制**: 确保任务不偏离,异常时主动接管
2. **循环任务支持**: 可无限期运行,适合自动化场景
3. **经验学习**: 越用越快,越用越聪明
4. **技术平衡**: 不过度追求完美,在实现复杂度和效果间取得平衡
5. **可扩展性**: 模块化设计,易于增加新功能

---

**文档版本**: v1.0
**创建时间**: 2025-11-01
**类型**: 顶层架构设计
