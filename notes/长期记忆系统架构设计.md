# 长期记忆系统架构设计 - Reflexion + Experience Replay

## 一、系统概述

本方案设计一个基于经验学习的长期记忆系统，使 Agent 能够：
1. **首次探索**：通过 Reflexion 循环探索并完成新任务
2. **经验沉淀**：将成功的执行路径保存到长期记忆
3. **快速复用**：后续遇到相似任务时直接检索并应用经验

### 核心理念
> "第一次探索，第二次直达"

---

## 二、架构设计

### 2.1 系统分层

```
┌─────────────────────────────────────┐
│      Task Input Layer               │  用户任务输入
├─────────────────────────────────────┤
│   Memory Retrieval Layer            │  经验检索层
│   ├─ Task Embedding                 │
│   ├─ Similarity Search              │
│   └─ Experience Matching            │
├─────────────────────────────────────┤
│   Execution Strategy Layer          │  执行策略层
│   ├─ Direct Replay (有经验)         │
│   ├─ Reflexion Explore (无经验)     │
│   └─ Hybrid Mode (部分匹配)         │
├─────────────────────────────────────┤
│   Experience Learning Layer         │  经验学习层
│   ├─ Success Pattern Extract        │
│   ├─ Memory Consolidation           │
│   └─ Index Update                   │
├─────────────────────────────────────┤
│   Storage Layer                     │  存储层
│   ├─ Vector DB (任务语义索引)       │
│   ├─ Graph DB (操作序列图)          │
│   └─ Key-Value Store (元数据)       │
└─────────────────────────────────────┘
```

---

## 三、核心模块设计

### 3.1 任务经验存储结构

#### 经验记录 Schema

**ActionStep - 单个操作步骤**
- step_id: 步骤编号
- action_type: 操作类型（click, swipe, input, wait）
- target: 控件描述或坐标
- params: 操作参数
- screenshot_before/after: 截图路径
- success: 是否成功
- duration_ms: 耗时

**TaskExperience - 任务经验记录**

任务元数据：
- task_description: 任务描述
- task_intent: 任务意图（购物、社交、娱乐等）
- app_name: 应用名称
- task_tags: 任务标签列表

执行记录：
- action_sequence: 操作步骤序列
- total_steps: 总步骤数
- total_duration_ms: 总耗时
- success_rate: 成功率（动态更新）

上下文信息：
- device_info: 设备信息
- app_version: 应用版本
- ui_structure: 关键 UI 元素描述

学习元数据：
- created_at: 创建时间
- last_used_at: 最后使用时间
- use_count: 使用次数
- feedback_score: 用户反馈评分
- embedding: 任务语义向量

**ExperienceGraph - 经验图谱（用于泛化）**
- graph_id: 图谱 ID
- task_pattern: 任务模式（如："在{app}搜索{商品}并下单"）
- common_path: 通用路径节点
- variable_slots: 可变槽位
- success_cases: 成功案例 ID 列表

---

### 3.2 存储方案

#### 方案一：轻量级方案（推荐快速实现）

**技术栈**：ChromaDB + SQLite

**核心功能**：
- 向量存储：使用 ChromaDB 进行语义搜索
- 详细数据：使用 SQLite 或 JSON 存储完整经验数据
- 嵌入模型：paraphrase-multilingual-MiniLM-L12-v2

**关键操作**：
- save_experience: 保存经验（向量索引 + 完整数据）
- search_similar_tasks: 语义搜索相似任务（支持相似度阈值过滤）

#### 方案二：高级方案（大规模应用）

**技术栈**：
- Qdrant / Milvus：向量数据库（百万级语义搜索）
- Neo4j：图数据库（任务依赖关系、泛化模式）
- PostgreSQL：关系数据库（元数据、统计分析）

---

### 3.3 经验检索与匹配算法

#### 多级检索策略

**三级检索**：

1. **精确匹配（Level 1）**
   - 通过任务描述哈希快速查找
   - 成功率 > 0.9 时直接复用
   - 策略：direct_replay

2. **语义相似匹配（Level 2）**
   - 使用向量相似度搜索（top_k=5, threshold=0.75）
   - 相似度 > 0.85 时轻微调整后执行
   - 策略：adaptive_replay

3. **模式匹配（Level 3）**
   - 使用 NER 提取实体
   - 匹配经验图谱中的通用模式
   - 策略：guided_exploration

4. **无匹配**
   - 启动完全新探索
   - 策略：reflexion_explore

#### 相似度计算

**综合相似度 = 语义相似度(70%) + App 匹配度(15%) + 意图匹配度(15%)**

- 语义相似度：使用预训练模型 embedding
- App 匹配：应用名称是否一致
- 意图匹配：任务意图分类相似度

---

### 3.4 经验学习与优化机制

#### 经验提取流程

1. **提取关键操作序列**
   - 去除重复点击、无效等待、错误回退操作

2. **标注关键决策点**
   - 页面跳转点
   - 搜索输入点
   - 确认操作点

3. **提取 UI 元素特征**
   - 用于后续控件定位

4. **构建经验对象**
   - 生成完整的 TaskExperience
   - 生成语义向量 embedding

#### 经验优化与泛化

**经验泛化**：
- 聚类相似任务（如：多个"在淘宝买XXX"任务）
- 提取公共路径和可变槽位
- 生成通用模式模板（如："在{app}搜索{商品}并下单"）
- 创建 ExperienceGraph 保存到图数据库

**成功率更新**：
- 使用指数移动平均（EMA）平滑更新
- 成功率 < 0.5 时标记为需要重新探索
- 更新使用次数和最后使用时间

---

## 四、集成到 LangGraph 工作流

### 4.1 增强的工作流设计

**新增节点**：
- memory_retrieve：经验检索节点
- experience_learn：经验学习节点

**工作流程**：
```
memory_retrieve → 路由决策 → 执行 → verify → experience_learn
                   ├─ direct_replay → execute
                   ├─ adaptive_replay → analyze
                   ├─ guided_exploration → capture
                   └─ reflexion_explore → capture
```

**原有 Reflexion 循环**：
```
capture → analyze → generate_code → execute → verify
         ↑                                      ↓
         └──────────── retry ──────────────────┘
```

### 4.2 路由策略

**根据经验匹配结果路由**：

- **direct_replay**（置信度 > 0.9）：直接执行经验操作序列
- **adaptive_replay**（置信度 > 0.75）：轻微调整后执行
- **guided_exploration**：使用模式模板引导探索
- **reflexion_explore**：完全新探索

**经验学习触发**：
- 仅在 Reflexion 探索成功后学习（避免重复）
- 异步触发泛化任务（不阻塞主流程）

---

## 五、性能优化策略

### 5.1 检索优化

**多级缓存**：
- L1 缓存：内存 LRU Cache（100 条）
- L2 缓存：Redis Cache（TTL=1小时）
- L3 存储：持久化数据库

**批量预加载**：
- 启动时预加载 Top 50 高频任务

### 5.2 向量索引优化

**使用 HNSW 索引**：
- 空间：cosine
- M（连接数）：16
- ef_construction：200

---

## 六、监控与评估指标

### 关键指标

**检索效率**：
- retrieval_hit_rate：命中率
- avg_retrieval_time_ms：平均检索耗时

**执行效率**：
- replay_success_rate：复用成功率
- avg_speedup_factor：平均加速倍数

**学习质量**：
- experience_reuse_count：经验复用次数
- experience_decay_rate：经验衰减率
- generalization_accuracy：泛化准确率

**存储**：
- total_experiences：总经验数
- avg_experience_size_kb：平均经验大小
- storage_growth_rate：存储增长率

---

## 七、注意事项与最佳实践

### 隐私与安全
- 过滤敏感输入（password, credit_card, id_number）
- 敏感字段替换为 [REDACTED]

### 版本兼容
- 检查经验的 app_version 是否匹配当前版本
- 不匹配时标记为"实验性复用"

### 经验衰减策略
- 定期清理 90 天未使用且成功率 < 0.5 的经验
- 避免存储膨胀

---

## 八、预期效果

| 场景 | 首次执行 | 第二次执行 | 加速比 |
|-----|---------|-----------|-------|
| 简单任务 | 5-10 秒 | 1-2 秒 | 5x |
| 复杂任务 | 30-60 秒 | 5-10 秒 | 6x |
| 超复杂任务 | 2-5 分钟 | 20-40 秒 | 8x |

---

## 九、实施路线图

### Phase 1: MVP（1-2 周）
- 实现 TaskExperience 和 MemoryStore 基础类
- 集成 ChromaDB 做语义搜索
- 实现 memory_retrieve 和 experience_learn 节点
- 基础精确匹配和语义匹配

### Phase 2: 优化（2-3 周）
- 实现经验优化算法（去冗余、标注决策点）
- 添加成功率追踪和自动淘汰机制
- 实现多级缓存
- 添加监控和统计面板

### Phase 3: 高级特性（3-4 周）
- 实现经验泛化（模式提取）
- 集成图数据库做模式匹配
- 实现跨设备经验迁移
- 添加用户反馈循环

---

**文档版本**: v2.0 (架构设计版)
**创建时间**: 2025-11-01
**维护者**: DroidRun-VL Team
